<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel do Barbeiro</title>
<link rel="icon" type="image/png" href="favicon-removebg-preview.png" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ===== RESET & BASE ===== */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
body { background:#f4f1ee; min-height:100vh; display:flex; justify-content:center; padding:20px; color:#4e342e; }

/* ===== CONTAINER ===== */
#painelContainer { width:100%; max-width:1400px; }

/* ===== HEADER ===== */
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:8px; }
.header h1 { font-size:26px; font-weight:700; color:#3e2723; }
.header span { font-weight:600; font-size:15px; color:#6d4c41; }

/* ===== CARDS ===== */
.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:16px; margin-bottom:20px; }
.card { background:#fff; padding:22px 18px; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,0.08); text-align:center; transition:0.25s; }
.card:hover { transform:translateY(-3px); }
.card h3 { font-size:14px; color:#795548; margin-bottom:8px; font-weight:600; }
.card p { font-size:22px; font-weight:700; color:#3e2723; }

/* ===== FILTROS ===== */
.filters { display:flex; gap:12px; align-items:center; margin-bottom:20px; flex-wrap:wrap; background:#fff; padding:14px 16px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,0.06); }
.filters label { font-weight:600; font-size:14px; }
select, input[type="date"] { padding:9px 10px; border-radius:8px; border:1px solid #c7b7ad; background:#fff; font-size:14px; }
.filters button { padding:9px 14px; border-radius:8px; border:none; background:#8d6e63; cursor:pointer; font-weight:600; color:#fff; font-size:14px; transition:0.2s; }
.filters button:hover { background:#6d4c41; }

/* ===== TABELA ===== */
.table-container { width:100%; overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.08); margin-bottom:16px; min-width:600px; }
th, td { padding:12px; text-align:left; font-size:14px; }
th { background:#4e342e; color:#fff; }
tr:nth-child(even) { background:#fdfaf8; }
tr:hover { background:#f3edea; }
.no-appointments { margin:14px 0; font-style:italic; text-align:center; color:#6d4c41; font-size:14px; }

/* ===== DASHBOARD GERENTE ===== */
#gerentePanel { margin-top:30px; display:none; background:#fff; padding:24px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
#gerentePanel h2 { margin-bottom:12px; }
#ganhosBarbeiros { display:flex; gap:12px; flex-wrap:wrap; list-style:none; padding:0; margin-top:16px; }
#ganhosBarbeiros li { background:#4e342e; color:#fff; padding:10px 16px; border-radius:10px; font-weight:600; }

/* ===== BOTÕES ===== */
.editBtn, .delBtn { padding:6px 10px; margin:0 2px; border:none; border-radius:6px; font-size:12px; cursor:pointer; color:#fff; transition:0.2s; }
.editBtn { background:#ffb74d; }
.editBtn:hover { background:#ffa726; }
.delBtn { background:#e57373; }
.delBtn:hover { background:#ef5350; }

/* ===== MODAL ===== */
/* ===== MODAL (visual melhorado) ===== */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(6px);
  display: flex; justify-content: center; align-items: center;
  opacity: 0; visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
}
.modal.active { opacity: 1; visibility: visible; }

.modal-content {
  background: linear-gradient(145deg, #ffffff, #f5f1ee);
  padding: 28px;
  border-radius: 18px;
  width: 92%;
  max-width: 650px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 35px rgba(0,0,0,0.15);
  text-align: center;
  animation: slideIn 0.4s ease;
}

.modal-content h3 {
  font-size: 22px;
  color: #3e2723;
  font-weight: 700;
  margin-bottom: 14px;
}

.modal-content canvas {
  display: block;
  width: 100%;
  height: auto !important; 
  aspect-ratio: 16 / 9; 
  margin: 16px 0;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  padding: 10px;
}

.modal-content p {
  background: #f9f5f3;
  border-radius: 10px;
  padding: 12px;
  color: #4e342e;
  font-weight: 600;
  line-height: 1.5;
  margin-top: 10px;
}

.modal-content button {
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: #4e342e;
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  transition: 0.25s;
  margin-top: 16px;
}

.modal-content button:hover {
  background: #6d4c41;
  transform: scale(1.05);
}



/* ===== RESPONSIVO ===== */
@media (max-width:768px) { body { padding:12px; } .header h1 { font-size:22px; } .cards { grid-template-columns:repeat(2,1fr); gap:12px; } .card p { font-size:20px; } .filters { flex-direction:column; align-items:flex-start; gap:10px; } .filters button, select, input { width:100%; } .table-container { border-radius:10px; } }
@media (max-width:480px) { .cards { grid-template-columns:1fr; } .header { flex-direction:column; align-items:flex-start; gap:6px; } .header h1 { font-size:20px; } .header span { font-size:13px; } .card h3 { font-size:13px; } .card p { font-size:18px; } .filters label { font-size:13px; } }
</style>
</head>
<body>

<div id="painelContainer">

  <!-- HEADER -->
  <div class="header">
    <h1>Painel do Barbeiro</h1>
    <span>Soul Fade</span>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card"><h3>Ganhos</h3><p id="cardGanhos">R$ 0,00</p></div>
    <div class="card"><h3>Clientes</h3><p id="cardClientes">0</p></div>
    <div class="card"><h3>Agendamentos</h3><p id="cardAgendamentos">0</p></div>
    <div class="card"><h3>Avaliação</h3><p id="cardAvaliacao">⭐ 8,5</p></div>
  </div>

  <!-- FILTROS -->
  <div class="filters">
    <label for="barbeiroSelect">Barbeiro:</label>
    <select id="barbeiroSelect">
      <option value="">-- Todos --</option>
      <option value="Lucas Dias">Lucas Dias</option>
      <option value="Isaias Barreto">Isaias Barreto</option>
      <option value="Isaias Santana">Isaias Santana</option>
    </select>

    <label for="pagamentoSelect">Pagamento:</label>
    <select id="pagamentoSelect">
      <option value="">-- Todos --</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cartão">Cartão</option>
      <option value="Pix">Pix</option>
    </select>

    <label for="dateSelect">Data:</label>
    <input type="date" id="dateSelect" />

    <button id="clearFilters">Limpar filtros</button>
    <button id="novoAgendamentoBtn">Novo Agendamento</button>
    <button id="fecharMesBtn" style="background:#4e342e">Fechar Mês</button>

  </div>

  <!-- TABELA -->
  <div class="table-container">
    <table id="agendaTable">
      <thead>
        <tr><th>Dia</th><th>Horário</th><th>Cliente</th><th>Serviço</th><th>Barbeiro</th><th>Pagamento</th><th>Ações</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="noAppointments" class="no-appointments">Selecione um barbeiro ou uma data para ver os agendamentos.</div>

  <!-- Painel Gerente -->
  <div id="gerentePanel">
    <h2>Dashboard do Gerente</h2>
    <p>Aqui você verá vendas e desempenho dos barbeiros:</p>
    <ul id="ganhosBarbeiros"></ul>
  </div>
</div>

<!-- Modal Editar -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>Editar Agendamento</h3>
    <label>Data:</label>
    <input type="date" id="editDia" />
    <label>Horário:</label>
    <input type="time" id="editHorario" />
    <label>Barbeiro:</label>
    <select id="editBarbeiro">
      <option value="Lucas Dias">Lucas Dias</option>
      <option value="Isaias Barreto">Isaias Barreto</option>
      <option value="Isaias Santana">Isaias Santana</option>
    </select>
    <label>Pagamento:</label>
    <select id="editPagamento">
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cartão">Cartão</option>
      <option value="Pix">Pix</option>
    </select>
    <div>
      <button class="saveBtn">Salvar</button>
      <button class="cancelBtn">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Relatório Mensal -->
<div id="relatorioModal" class="modal">
  <div class="modal-content">
    <h3>Relatório Mensal</h3>

    <canvas id="graficoPagamentos"></canvas>
    <canvas id="graficoServicos"></canvas>

    <p id="resumoMensal"></p>

    <button id="fecharRelatorio">Fechar Relatório</button>
  </div>
</div>


<!-- Modal Novo -->
<div id="novoModal" class="modal">
  <div class="modal-content">
    <h3>Novo Agendamento</h3>
    <label>Barbeiro:</label>
    <select id="novoBarbeiro">
      <option value="Lucas Dias">Lucas Dias</option>
      <option value="Isaias Barreto">Isaias Barreto</option>
      <option value="Isaias Santana">Isaias Santana</option>
    </select>
    <label>Data:</label>
    <input type="date" id="novoDia" />
    <label>Horário:</label>
    <select id="novoHorario">
      <option value="09:00">09:00</option>
      <option value="10:00">10:00</option>
      <option value="11:00">11:00</option>
      <option value="12:00">12:00</option>
      <option value="13:00">13:00</option>
      <option value="14:00">14:00</option>
      <option value="15:00">15:00</option>
      <option value="16:00">16:00</option>
      <option value="17:00">17:00</option>
      <option value="18:00">18:00</option>
    </select>
    <label>Cliente:</label>
    <input type="text" id="novoCliente" placeholder="Nome do cliente" />
    <label>Serviço:</label>
    <input type="text" id="novoServico" placeholder="Ex: Corte Tradicional" />
    <label>Pagamento:</label>
    <select id="novoPagamento">
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cartão">Cartão</option>
      <option value="Pix">Pix</option>
    </select>
    <div>
      <button class="saveBtn" id="salvarNovo">Salvar</button>
      <button class="cancelBtn" id="cancelarNovo">Cancelar</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://soulfade.onrender.com/api";

// ELEMENTOS
const barbeiroSelect = document.getElementById("barbeiroSelect");
const pagamentoSelect = document.getElementById("pagamentoSelect");
const dateSelect = document.getElementById("dateSelect");
const tableBody = document.querySelector("#agendaTable tbody");
const noAppointments = document.getElementById("noAppointments");
const gerentePanel = document.getElementById("gerentePanel");
const ganhosBarbeirosList = document.getElementById("ganhosBarbeiros");
const cardGanhos = document.getElementById("cardGanhos");
const cardClientes = document.getElementById("cardClientes");
const cardAgendamentos = document.getElementById("cardAgendamentos");

// MODAL E INPUTS
const editModal = document.getElementById("editModal");
const editDia = document.getElementById("editDia");
const editHorario = document.getElementById("editHorario");
const editBarbeiro = document.getElementById("editBarbeiro");
const editPagamento = document.getElementById("editPagamento");
let editId = null;

const novoModal = document.getElementById("novoModal");
const novoDia = document.getElementById("novoDia");
const novoHorario = document.getElementById("novoHorario");
const novoCliente = document.getElementById("novoCliente");
const novoServico = document.getElementById("novoServico");
const novoBarbeiro = document.getElementById("novoBarbeiro");
const novoPagamento = document.getElementById("novoPagamento");

// FUNÇÃO CARREGAR AGENDAMENTOS COM FILTROS
async function carregarAgendamentos(barbeiro, dia, pagamento) {
  try {
    let url = `${API_URL}/agendamentos`;
    const params = new URLSearchParams();
    if (barbeiro) params.set("barbeiro", barbeiro);
    if (dia) params.set("dia", dia);
    if (params.toString()) url += "?" + params.toString();

    const res = await fetch(url);
    let agendamentos = await res.json();

    // FILTRO: mês atual, ano atual e forma de pagamento
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    agendamentos = agendamentos.filter(a => {
      const data = new Date(a.dia);
      const mesCorreto = data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
      const pagamentoCorreto = pagamento ? a.pagamento === pagamento : true;
      return mesCorreto && pagamentoCorreto;
    });

    tableBody.innerHTML = "";
    if (!agendamentos.length) {
      noAppointments.style.display = "block";
      return;
    }
    noAppointments.style.display = "none";

    agendamentos.forEach(a => {
      const diaFmt = a.dia.split("T")[0].split("-").reverse().join("/");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${diaFmt}</td>
        <td>${a.horario}</td>
        <td>${a.nome}</td>
        <td>${a.servico}</td>
        <td>${a.barbeiro}</td>
        <td>${a.pagamento || "-"}</td>
        <td>
          <button class="editBtn" data-id="${a.id}">Editar</button>
          <button class="delBtn" data-id="${a.id}">Excluir</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });

    ativarBotoes();
  } catch (err) {
    console.error(err);
    tableBody.innerHTML = "";
    noAppointments.style.display = "block";
  }
}


// FUNÇÃO ATIVAR BOTÕES DE EDITAR E EXCLUIR
function ativarBotoes() {
  document.querySelectorAll(".delBtn").forEach(btn => {
    btn.onclick = async () => {
      if (!confirm("Deseja realmente excluir este agendamento?")) return;
      const id = btn.dataset.id;
      try { 
        await fetch(`${API_URL}/agendamentos/${id}`, { method: "DELETE" });
        atualizarTudo();
      } catch(e){ console.error(e); }
    };
  });

  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.onclick = () => {
      editId = btn.dataset.id;
      const tr = btn.closest("tr");
      editDia.value = tr.children[0].textContent.split('/').reverse().join('-');
      editHorario.value = tr.children[1].textContent;
      editBarbeiro.value = tr.children[4].textContent;
      editPagamento.value = tr.children[5].textContent;
      editModal.classList.add("active");
    };
  });
}

// SALVAR EDIÇÃO
editModal.querySelector(".saveBtn").onclick = async () => {
  if(!editDia.value || !editHorario.value || !editBarbeiro.value || !editPagamento.value) return alert("Preencha todos os campos!");
  try{
    await fetch(`${API_URL}/agendamentos/${editId}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        dia: editDia.value,
        horario: editHorario.value,
        barbeiro: editBarbeiro.value,
        pagamento: editPagamento.value
      })
    });
    editModal.classList.remove("active");
    atualizarTudo();
  }catch(e){ console.error(e); }
};
editModal.querySelector(".cancelBtn").onclick = () => editModal.classList.remove("active");

// NOVO AGENDAMENTO
document.getElementById("novoAgendamentoBtn").onclick = () => {
  novoDia.value = "";
  novoHorario.value = "09:00";
  novoCliente.value = "";
  novoServico.value = "";
  novoBarbeiro.value = "Lucas Dias";
  novoPagamento.value = "Dinheiro";
  novoModal.classList.add("active");
};
document.getElementById("cancelarNovo").onclick = () => novoModal.classList.remove("active");

document.getElementById("salvarNovo").onclick = async () => {
  if(!novoDia.value || !novoHorario.value || !novoCliente.value || !novoServico.value || !novoBarbeiro.value || !novoPagamento.value){
    return alert("Preencha todos os campos!");
  }
  try{
    await fetch(`${API_URL}/agendamentos`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        dia: novoDia.value,
        horario: novoHorario.value,
        nome: novoCliente.value,
        servico: novoServico.value,
        barbeiro: novoBarbeiro.value,
        pagamento: novoPagamento.value
      })
    });
    novoModal.classList.remove("active");
    atualizarTudo();
  }catch(e){ console.error(e); }
};

// FILTROS
barbeiroSelect.onchange = atualizarTudo;
pagamentoSelect.onchange = atualizarTudo;
dateSelect.onchange = atualizarTudo;
document.getElementById("clearFilters").onclick = () => {
  barbeiroSelect.value = "";
  pagamentoSelect.value = "";
  dateSelect.value = "";
  atualizarTudo();
};

// FUNÇÃO ATUALIZAR CARDS
async function atualizarCards(barbeiro, dia) {
  try {
    const res = await fetch(`${API_URL}/agendamentos`);
    const agendamentos = await res.json();
    let ganhos = 0;
    let clientes = new Set();
    agendamentos.forEach(a => {
      if((!barbeiro || a.barbeiro === barbeiro) && (!dia || a.dia.startsWith(dia))) {
        ganhos += a.valor ? Number(a.valor) : 50; // Valor padrão
        clientes.add(a.nome);
      }
    });
    cardGanhos.textContent = `R$ ${ganhos.toFixed(2)}`;
    cardClientes.textContent = clientes.size;
    cardAgendamentos.textContent = agendamentos.length;
  } catch(e){ console.error(e); }
}

// FUNÇÃO CARREGAR GANHOS DO GERENTE
async function carregarGanhosGerente() {
  try {
    const res = await fetch(`${API_URL}/agendamentos`);
    const agendamentos = await res.json();
    const barbeiros = {};
    agendamentos.forEach(a => {
      const valor = a.valor ? Number(a.valor) : 50;
      if(!barbeiros[a.barbeiro]) barbeiros[a.barbeiro] = 0;
      barbeiros[a.barbeiro] += valor;
    });
    ganhosBarbeirosList.innerHTML = "";
    for(const b in barbeiros) {
      const li = document.createElement("li");
      li.textContent = `${b}: R$ ${barbeiros[b].toFixed(2)}`;
      ganhosBarbeirosList.appendChild(li);
    }
    gerentePanel.style.display = "block";
  } catch(e){ console.error(e); }
}

// FUNÇÃO ATUALIZAR TUDO
function atualizarTudo() {
  carregarAgendamentos(barbeiroSelect.value, dateSelect.value, pagamentoSelect.value);
  atualizarCards(barbeiroSelect.value,dateSelect.value);
  carregarGanhosGerente();
}

// ======== FECHAR MÊS ========
document.getElementById("fecharMesBtn").onclick = async () => {
  try {
    const res = await fetch(`${API_URL}/agendamentos`);
    const agendamentos = await res.json();

    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    // Filtra só o mês atual
    const agMes = agendamentos.filter(a => {
      const data = new Date(a.dia);
      return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
    });

    if (!agMes.length) return alert("Nenhum agendamento neste mês!");

    // === Estatísticas ===
    const totalClientes = new Set(agMes.map(a => a.nome)).size;
    const totalAtendimentos = agMes.length;

    const pagamentos = { Pix: 0, Cartão: 0, Dinheiro: 0 };
    const servicos = {};

    agMes.forEach(a => {
      if (a.pagamento && pagamentos[a.pagamento] !== undefined) pagamentos[a.pagamento]++;
      if (a.servico) servicos[a.servico] = (servicos[a.servico] || 0) + 1;
    });

    const totalGanhos = agMes.reduce((acc, a) => acc + (Number(a.valor) || 50), 0);

    // === Atualiza texto resumo ===
    document.getElementById("resumoMensal").innerHTML = `
      Total de clientes únicos: ${totalClientes}<br>
      Total de atendimentos: ${totalAtendimentos}<br>
      Ganhos estimados: R$ ${totalGanhos.toFixed(2)}
    `;

    // === Gera gráficos ===
    gerarGraficos(pagamentos, servicos);

    // Abre modal
    document.getElementById("relatorioModal").classList.add("active");
    // Aguarda um pouquinho o render dos gráficos e gera PDF
setTimeout(() => {
  gerarPDFRelatorio();
}, 1200);

  } catch (err) {
    console.error(err);
    alert("Erro ao gerar relatório!");
  }
};

document.getElementById("fecharRelatorio").onclick = () => {
  document.getElementById("relatorioModal").classList.remove("active");
};

// ======== FUNÇÃO GERAR GRÁFICOS ========
function gerarGraficos(pagamentos, servicos) {
  const ctxPag = document.getElementById("graficoPagamentos").getContext("2d");
  const ctxServ = document.getElementById("graficoServicos").getContext("2d");

  if (window.graficoPag) window.graficoPag.destroy();
  if (window.graficoServ) window.graficoServ.destroy();

  // === Gráfico de pagamentos ===
  window.graficoPag = new Chart(ctxPag, {
    type: "pie",
    data: {
      labels: Object.keys(pagamentos),
      datasets: [{
        data: Object.values(pagamentos),
        backgroundColor: ["#4caf50", "#2196f3", "#ff9800"]
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: "Formas de Pagamento" }
      }
    }
  });

  // === Gráfico de serviços ===
  window.graficoServ = new Chart(ctxServ, {
    type: "bar",
    data: {
      labels: Object.keys(servicos),
      datasets: [{
        label: "Quantidade de Cortes/Serviços",
        data: Object.values(servicos),
        backgroundColor: "#8d6e63"
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: "Serviços Realizados" }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

async function gerarPDFRelatorio() {
  const modal = document.querySelector("#relatorioModal .modal-content");
  const canvas = await html2canvas(modal);
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jspdf.jsPDF("p", "mm", "a4");
  const width = pdf.internal.pageSize.getWidth();
  const height = (canvas.height * width) / canvas.width;
  pdf.addImage(imgData, "PNG", 0, 0, width, height);
  pdf.save("Relatorio-Mensal.pdf");
}


// INICIALIZAÇÃO
atualizarTudo();
</script>

</body>
</html>
